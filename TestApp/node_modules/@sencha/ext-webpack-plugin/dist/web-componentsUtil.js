"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports._getDefaultVars = _getDefaultVars;
exports._extractFromSource = _extractFromSource;
exports._toProd = _toProd;
exports._toDev = _toDev;
exports._getAllComponents = _getAllComponents;
exports._writeFilesToProdFolder = _writeFilesToProdFolder;

function _getDefaultVars() {
  return {
    touchFile: '/src/themer.js',
    watchStarted: false,
    buildstep: '1 of 1',
    firstTime: true,
    firstCompile: true,
    browserCount: 0,
    manifest: null,
    extPath: 'ext',
    pluginErrors: [],
    deps: [],
    usedExtWebComponents: [],
    rebuild: true
  };
}

function _extractFromSource(module, options, compilation, ExtWebComponents) {
  const logv = require('./pluginUtil').logv;

  const verbose = options.verbose;
  logv(verbose, 'FUNCTION _extractFromSource');
  var js = module._source._value;
  logv(verbose, module.resource);
  var statements = [];

  var generate = require("@babel/generator").default;

  var parse = require("babylon").parse;

  var traverse = require("ast-traverse");

  var ast = parse(js, {
    plugins: ['typescript', 'flow', 'doExpressions', 'objectRestSpread', 'classProperties', 'exportDefaultFrom', 'exportExtensions', 'asyncGenerators', 'functionBind', 'functionSent', 'dynamicImport'],
    sourceType: 'module'
  });
  traverse(ast, {
    pre: function (node) {
      if (node.type === 'CallExpression' && node.callee && node.callee.object && node.callee.object.name === 'Ext') {
        statements.push(generate(node).code);
      }

      if (node.type === 'CallExpression') {
        const code = generate(node).code;
        statements = statements.concat(getXtypeFromHTMLJS(code, statements, ExtWebComponents));
      }

      if (node.type === 'StringLiteral') {
        let code = node.value;

        for (var i = 0; i < code.length; ++i) {
          if (code.charAt(i) == '<') {
            if (code.substr(i, 4) == '<!--') {
              i += 4;
              i += code.substr(i).indexOf('-->') + 3;
            } else if (code.charAt(i + 1) !== '/') {
              var start = code.substring(i);
              var end = getEnd(start, [' ', '\n', '>']);
              var xtype = start.substring(1, end);

              if (ExtWebComponents.includes(xtype)) {
                xtype = xtype.substring(4, end);
                var theValue = node.value.toLowerCase();

                if (theValue.indexOf('doctype html') == -1) {
                  var config = `Ext.create(${JSON.stringify({
                    xtype: xtype
                  })})`;

                  if (statements.indexOf(config) < 0) {
                    statements.push(config);
                  }
                }
              }

              i += end;
            }
          }
        }

        statements = statements.concat(getXtypeFromHTMLJS(code, statements, ExtWebComponents));
      }
    }
  });
  return statements;
}

function getXtypeFromHTMLJS(code, statements, ExtWebComponents) {
  const logv = require('./pluginUtil').logv;

  const result = [];
  const xtypeRepetitons = (code.match(/xtype/g) || []).length;

  if (xtypeRepetitons > 0) {
    for (var j = 0; j < xtypeRepetitons; j++) {
      var start = code.substring(code.indexOf('xtype') + 5);
      var ifAsProps = start.indexOf(':');
      var ifAsAttribute = start.indexOf('=');
      start = start.substring(Math.min(ifAsProps, ifAsAttribute) + 1);
      start = start.trim();
      var end = getEnd(start, ['\n', '>', '}', '\r']);
      var xtype = start.substring(1, end).trim().replace(/['",]/g, '');
      var config = `Ext.create(${JSON.stringify({
        xtype: xtype
      })})`;

      if (ExtWebComponents.includes('ext-' + xtype) && statements.indexOf(config) === -1) {
        result.push(config);
      }

      code = start.substr(end).trim();
    }
  }

  return result;
}

function _toProd(vars, options) {
  const logv = require('./pluginUtil').logv;

  logv(options.verbose, 'FUNCTION _toProd (empty');

  try {} catch (e) {
    console.log(e);
    return [];
  }
}

function _toDev(vars, options) {
  try {} catch (e) {
    console.log(e);
    return [];
  }
}

function _getAllComponents(vars, options) {
  const log = require('./pluginUtil').log;

  const logv = require('./pluginUtil').logv;

  logv(options.verbose, 'FUNCTION _getAllComponents');

  const path = require('path');

  const fsx = require('fs-extra');

  var ExtWebComponents = [];
  const packageLibPath = path.resolve(process.cwd(), 'node_modules/@sencha/ext-web-components-modern/dist');
  var files = fsx.readdirSync(packageLibPath);
  files.forEach(fileName => {
    if (fileName && fileName.substr(0, 4) == 'ext-') {
      var end = fileName.substr(4).indexOf('.component');

      if (end >= 0) {
        ExtWebComponents.push(fileName.substring(0, end + 4));
      }
    }
  });
  logv(options.verbose, `Identifying all ext-${options.framework}-modern modules`); //log(vars.app, `Identifying all ext-${options.framework} modules`)

  return ExtWebComponents;
}

function _writeFilesToProdFolder(vars, options) {
  const logv = require('./pluginUtil').logv;

  logv(options.verbose, 'FUNCTION _writeFilesToProdFolder (empty)');

  try {} catch (e) {
    console.log(e);
  }
}

function getEnd(start, setOfSymbolsToCheck) {
  var endingsArr = [];

  for (var i = 0; i < setOfSymbolsToCheck.length; i++) {
    var symbolIndex = start.indexOf(setOfSymbolsToCheck[i]);

    if (symbolIndex !== -1) {
      endingsArr.push(symbolIndex);
    }
  }

  return Math.min(...endingsArr);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93ZWItY29tcG9uZW50c1V0aWwuanMiXSwibmFtZXMiOlsiX2dldERlZmF1bHRWYXJzIiwidG91Y2hGaWxlIiwid2F0Y2hTdGFydGVkIiwiYnVpbGRzdGVwIiwiZmlyc3RUaW1lIiwiZmlyc3RDb21waWxlIiwiYnJvd3NlckNvdW50IiwibWFuaWZlc3QiLCJleHRQYXRoIiwicGx1Z2luRXJyb3JzIiwiZGVwcyIsInVzZWRFeHRXZWJDb21wb25lbnRzIiwicmVidWlsZCIsIl9leHRyYWN0RnJvbVNvdXJjZSIsIm1vZHVsZSIsIm9wdGlvbnMiLCJjb21waWxhdGlvbiIsIkV4dFdlYkNvbXBvbmVudHMiLCJsb2d2IiwicmVxdWlyZSIsInZlcmJvc2UiLCJqcyIsIl9zb3VyY2UiLCJfdmFsdWUiLCJyZXNvdXJjZSIsInN0YXRlbWVudHMiLCJnZW5lcmF0ZSIsImRlZmF1bHQiLCJwYXJzZSIsInRyYXZlcnNlIiwiYXN0IiwicGx1Z2lucyIsInNvdXJjZVR5cGUiLCJwcmUiLCJub2RlIiwidHlwZSIsImNhbGxlZSIsIm9iamVjdCIsIm5hbWUiLCJwdXNoIiwiY29kZSIsImNvbmNhdCIsImdldFh0eXBlRnJvbUhUTUxKUyIsInZhbHVlIiwiaSIsImxlbmd0aCIsImNoYXJBdCIsInN1YnN0ciIsImluZGV4T2YiLCJzdGFydCIsInN1YnN0cmluZyIsImVuZCIsImdldEVuZCIsInh0eXBlIiwiaW5jbHVkZXMiLCJ0aGVWYWx1ZSIsInRvTG93ZXJDYXNlIiwiY29uZmlnIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlc3VsdCIsInh0eXBlUmVwZXRpdG9ucyIsIm1hdGNoIiwiaiIsImlmQXNQcm9wcyIsImlmQXNBdHRyaWJ1dGUiLCJNYXRoIiwibWluIiwidHJpbSIsInJlcGxhY2UiLCJfdG9Qcm9kIiwidmFycyIsImUiLCJjb25zb2xlIiwibG9nIiwiX3RvRGV2IiwiX2dldEFsbENvbXBvbmVudHMiLCJwYXRoIiwiZnN4IiwicGFja2FnZUxpYlBhdGgiLCJyZXNvbHZlIiwicHJvY2VzcyIsImN3ZCIsImZpbGVzIiwicmVhZGRpclN5bmMiLCJmb3JFYWNoIiwiZmlsZU5hbWUiLCJmcmFtZXdvcmsiLCJfd3JpdGVGaWxlc1RvUHJvZEZvbGRlciIsInNldE9mU3ltYm9sc1RvQ2hlY2siLCJlbmRpbmdzQXJyIiwic3ltYm9sSW5kZXgiXSwibWFwcGluZ3MiOiJBQUNBOzs7Ozs7Ozs7Ozs7QUFFTyxTQUFTQSxlQUFULEdBQTJCO0FBQ2hDLFNBQU87QUFDTEMsSUFBQUEsU0FBUyxFQUFFLGdCQUROO0FBRUxDLElBQUFBLFlBQVksRUFBRyxLQUZWO0FBR0xDLElBQUFBLFNBQVMsRUFBRSxRQUhOO0FBSUxDLElBQUFBLFNBQVMsRUFBRyxJQUpQO0FBS0xDLElBQUFBLFlBQVksRUFBRSxJQUxUO0FBTUxDLElBQUFBLFlBQVksRUFBRyxDQU5WO0FBT0xDLElBQUFBLFFBQVEsRUFBRSxJQVBMO0FBUUxDLElBQUFBLE9BQU8sRUFBRSxLQVJKO0FBU0xDLElBQUFBLFlBQVksRUFBRSxFQVRUO0FBVUxDLElBQUFBLElBQUksRUFBRSxFQVZEO0FBV0xDLElBQUFBLG9CQUFvQixFQUFFLEVBWGpCO0FBWUxDLElBQUFBLE9BQU8sRUFBRTtBQVpKLEdBQVA7QUFjRDs7QUFFTSxTQUFTQyxrQkFBVCxDQUE0QkMsTUFBNUIsRUFBb0NDLE9BQXBDLEVBQTZDQyxXQUE3QyxFQUEwREMsZ0JBQTFELEVBQTRFO0FBQ2pGLFFBQU1DLElBQUksR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBUCxDQUF3QkQsSUFBckM7O0FBQ0EsUUFBTUUsT0FBTyxHQUFHTCxPQUFPLENBQUNLLE9BQXhCO0FBQ0FGLEVBQUFBLElBQUksQ0FBQ0UsT0FBRCxFQUFTLDZCQUFULENBQUo7QUFDQSxNQUFJQyxFQUFFLEdBQUdQLE1BQU0sQ0FBQ1EsT0FBUCxDQUFlQyxNQUF4QjtBQUNBTCxFQUFBQSxJQUFJLENBQUNFLE9BQUQsRUFBU04sTUFBTSxDQUFDVSxRQUFoQixDQUFKO0FBQ0EsTUFBSUMsVUFBVSxHQUFHLEVBQWpC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LENBQWN5QyxtQkFBbUIsQ0FBQzdDLENBQUQsQ0FBakMsQ0FBbEI7O0FBRUEsUUFBSStDLFdBQVcsS0FBSyxDQUFDLENBQXJCLEVBQXdCO0FBQ3RCRCxNQUFBQSxVQUFVLENBQUNuRCxJQUFYLENBQWdCb0QsV0FBaEI7QUFDRDtBQUNIOztBQUNELFNBQU96QixJQUFJLENBQUNDLEdBQUwsQ0FBUyxHQUFHdUIsVUFBWixDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuXCJ1c2Ugc3RyaWN0XCJcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfZ2V0RGVmYXVsdFZhcnMoKSB7XHJcbiAgcmV0dXJuIHtcclxuICAgIHRvdWNoRmlsZTogJy9zcmMvdGhlbWVyLmpzJyxcclxuICAgIHdhdGNoU3RhcnRlZCA6IGZhbHNlLFxyXG4gICAgYnVpbGRzdGVwOiAnMSBvZiAxJyxcclxuICAgIGZpcnN0VGltZSA6IHRydWUsXHJcbiAgICBmaXJzdENvbXBpbGU6IHRydWUsXHJcbiAgICBicm93c2VyQ291bnQgOiAwLFxyXG4gICAgbWFuaWZlc3Q6IG51bGwsXHJcbiAgICBleHRQYXRoOiAnZXh0JyxcclxuICAgIHBsdWdpbkVycm9yczogW10sXHJcbiAgICBkZXBzOiBbXSxcclxuICAgIHVzZWRFeHRXZWJDb21wb25lbnRzOiBbXSxcclxuICAgIHJlYnVpbGQ6IHRydWVcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfZXh0cmFjdEZyb21Tb3VyY2UobW9kdWxlLCBvcHRpb25zLCBjb21waWxhdGlvbiwgRXh0V2ViQ29tcG9uZW50cykge1xyXG4gIGNvbnN0IGxvZ3YgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2XHJcbiAgY29uc3QgdmVyYm9zZSA9IG9wdGlvbnMudmVyYm9zZVxyXG4gIGxvZ3YodmVyYm9zZSwnRlVOQ1RJT04gX2V4dHJhY3RGcm9tU291cmNlJylcclxuICB2YXIganMgPSBtb2R1bGUuX3NvdXJjZS5fdmFsdWVcclxuICBsb2d2KHZlcmJvc2UsbW9kdWxlLnJlc291cmNlKVxyXG4gIHZhciBzdGF0ZW1lbnRzID0gW11cclxuXHJcbiAgdmFyIGdlbmVyYXRlID0gcmVxdWlyZShcIkBiYWJlbC9nZW5lcmF0b3JcIikuZGVmYXVsdFxyXG4gIHZhciBwYXJzZSA9IHJlcXVpcmUoXCJiYWJ5bG9uXCIpLnBhcnNlXHJcbiAgdmFyIHRyYXZlcnNlID0gcmVxdWlyZShcImFzdC10cmF2ZXJzZVwiKVxyXG5cclxuICB2YXIgYXN0ID0gcGFyc2UoanMsIHtcclxuICAgIHBsdWdpbnM6IFtcclxuICAgICAgJ3R5cGVzY3JpcHQnLFxyXG4gICAgICAnZmxvdycsXHJcbiAgICAgICdkb0V4cHJlc3Npb25zJyxcclxuICAgICAgJ29iamVjdFJlc3RTcHJlYWQnLFxyXG4gICAgICAnY2xhc3NQcm9wZXJ0aWVzJyxcclxuICAgICAgJ2V4cG9ydERlZmF1bHRGcm9tJyxcclxuICAgICAgJ2V4cG9ydEV4dGVuc2lvbnMnLFxyXG4gICAgICAnYXN5bmNHZW5lcmF0b3JzJyxcclxuICAgICAgJ2Z1bmN0aW9uQmluZCcsXHJcbiAgICAgICdmdW5jdGlvblNlbnQnLFxyXG4gICAgICAnZHluYW1pY0ltcG9ydCdcclxuICAgIF0sXHJcbiAgICBzb3VyY2VUeXBlOiAnbW9kdWxlJ1xyXG4gIH0pXHJcblxyXG4gIHRyYXZlcnNlKGFzdCwge1xyXG4gICAgcHJlOiBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICBpZiAobm9kZS50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nICYmIG5vZGUuY2FsbGVlICYmIG5vZGUuY2FsbGVlLm9iamVjdCAmJiBub2RlLmNhbGxlZS5vYmplY3QubmFtZSA9PT0gJ0V4dCcpIHtcclxuICAgICAgICBzdGF0ZW1lbnRzLnB1c2goZ2VuZXJhdGUobm9kZSkuY29kZSlcclxuICAgICAgfVxyXG4gICAgICBpZiAobm9kZS50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nKSB7XHJcbiAgICAgICAgY29uc3QgY29kZSA9IGdlbmVyYXRlKG5vZGUpLmNvZGU7XHJcbiAgICAgICAgc3RhdGVtZW50cyA9IHN0YXRlbWVudHMuY29uY2F0KGdldFh0eXBlRnJvbUhUTUxKUyhjb2RlLCBzdGF0ZW1lbnRzLCBFeHRXZWJDb21wb25lbnRzKSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYobm9kZS50eXBlID09PSAnU3RyaW5nTGl0ZXJhbCcpIHtcclxuICAgICAgICBsZXQgY29kZSA9IG5vZGUudmFsdWVcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvZGUubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgIGlmIChjb2RlLmNoYXJBdChpKSA9PSAnPCcpIHtcclxuICAgICAgICAgICAgaWYgKGNvZGUuc3Vic3RyKGksIDQpID09ICc8IS0tJykge1xyXG4gICAgICAgICAgICAgIGkgKz0gNFxyXG4gICAgICAgICAgICAgIGkgKz0gY29kZS5zdWJzdHIoaSkuaW5kZXhPZignLS0+JykgKyAzXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29kZS5jaGFyQXQoaSsxKSAhPT0gJy8nKSB7XHJcbiAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gY29kZS5zdWJzdHJpbmcoaSlcclxuICAgICAgICAgICAgICB2YXIgZW5kID0gZ2V0RW5kKHN0YXJ0LCBbJyAnLCAnXFxuJywgJz4nXSk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHh0eXBlID0gc3RhcnQuc3Vic3RyaW5nKDEsIGVuZClcclxuICAgICAgICAgICAgICAgIGlmKEV4dFdlYkNvbXBvbmVudHMuaW5jbHVkZXMoeHR5cGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgIHh0eXBlID0geHR5cGUuc3Vic3RyaW5nKDQsIGVuZCk7XHJcbiAgICAgICAgICAgICAgICAgIHZhciB0aGVWYWx1ZSA9IG5vZGUudmFsdWUudG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICAgICAgICAgICBpZiAodGhlVmFsdWUuaW5kZXhPZignZG9jdHlwZSBodG1sJykgPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY29uZmlnID0gYEV4dC5jcmVhdGUoJHtKU09OLnN0cmluZ2lmeSh7eHR5cGU6IHh0eXBlfSl9KWA7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZW1lbnRzLmluZGV4T2YoY29uZmlnKSA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHN0YXRlbWVudHMucHVzaChjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaSArPSBlbmRcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBzdGF0ZW1lbnRzID0gc3RhdGVtZW50cy5jb25jYXQoZ2V0WHR5cGVGcm9tSFRNTEpTKGNvZGUsIHN0YXRlbWVudHMsIEV4dFdlYkNvbXBvbmVudHMpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHN0YXRlbWVudHNcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0WHR5cGVGcm9tSFRNTEpTKGNvZGUsIHN0YXRlbWVudHMsIEV4dFdlYkNvbXBvbmVudHMpIHtcclxuICBjb25zdCBsb2d2ID0gcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndlxyXG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gIGNvbnN0IHh0eXBlUmVwZXRpdG9ucyA9IChjb2RlLm1hdGNoKC94dHlwZS9nKSB8fCBbXSkubGVuZ3RoO1xyXG5cclxuICBpZiAoeHR5cGVSZXBldGl0b25zID4gMCkge1xyXG4gICAgZm9yICh2YXIgaj0wOyBqPHh0eXBlUmVwZXRpdG9uczsgaisrKSB7XHJcbiAgICAgIHZhciBzdGFydCA9IGNvZGUuc3Vic3RyaW5nKGNvZGUuaW5kZXhPZigneHR5cGUnKSArIDUpO1xyXG4gICAgICB2YXIgaWZBc1Byb3BzID0gc3RhcnQuaW5kZXhPZignOicpO1xyXG4gICAgICB2YXIgaWZBc0F0dHJpYnV0ZSA9IHN0YXJ0LmluZGV4T2YoJz0nKTtcclxuICAgICAgc3RhcnQgPSBzdGFydC5zdWJzdHJpbmcoTWF0aC5taW4oaWZBc1Byb3BzLCBpZkFzQXR0cmlidXRlKSArIDEpO1xyXG4gICAgICBzdGFydCA9IHN0YXJ0LnRyaW0oKTtcclxuICAgICAgdmFyIGVuZCA9IGdldEVuZChzdGFydCwgWydcXG4nLCAnPicsJ30nLCAnXFxyJ10pXHJcbiAgICAgIHZhciB4dHlwZSA9IHN0YXJ0LnN1YnN0cmluZygxLCBlbmQpLnRyaW0oKS5yZXBsYWNlKC9bJ1wiLF0vZywgJycpO1xyXG5cclxuICAgICAgdmFyIGNvbmZpZyA9IGBFeHQuY3JlYXRlKCR7SlNPTi5zdHJpbmdpZnkoe3h0eXBlOiB4dHlwZX0pfSlgO1xyXG4gICAgICBpZihFeHRXZWJDb21wb25lbnRzLmluY2x1ZGVzKCdleHQtJyArIHh0eXBlKSAmJiBzdGF0ZW1lbnRzLmluZGV4T2YoY29uZmlnKSA9PT0gLTEpIHtcclxuICAgICAgICByZXN1bHQucHVzaChjb25maWcpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvZGUgPSBzdGFydC5zdWJzdHIoZW5kKS50cmltKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gX3RvUHJvZCh2YXJzLCBvcHRpb25zKSB7XHJcbiAgY29uc3QgbG9ndiA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3ZcclxuICBsb2d2KG9wdGlvbnMudmVyYm9zZSwnRlVOQ1RJT04gX3RvUHJvZCAoZW1wdHknKVxyXG4gIHRyeSB7XHJcbiAgfVxyXG4gIGNhdGNoIChlKSB7XHJcbiAgICBjb25zb2xlLmxvZyhlKVxyXG4gICAgcmV0dXJuIFtdXHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gX3RvRGV2KHZhcnMsIG9wdGlvbnMpIHtcclxuICB0cnkge1xyXG4gIH1cclxuICBjYXRjaCAoZSkge1xyXG4gICAgY29uc29sZS5sb2coZSlcclxuICAgIHJldHVybiBbXVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIF9nZXRBbGxDb21wb25lbnRzKHZhcnMsIG9wdGlvbnMpIHtcclxuICBjb25zdCBsb2cgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2dcclxuICBjb25zdCBsb2d2ID0gcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndlxyXG4gIGxvZ3Yob3B0aW9ucy52ZXJib3NlLCdGVU5DVElPTiBfZ2V0QWxsQ29tcG9uZW50cycpXHJcblxyXG4gIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcclxuICBjb25zdCBmc3ggPSByZXF1aXJlKCdmcy1leHRyYScpXHJcblxyXG4gIHZhciBFeHRXZWJDb21wb25lbnRzID0gW11cclxuICBjb25zdCBwYWNrYWdlTGliUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCAnbm9kZV9tb2R1bGVzL0BzZW5jaGEvZXh0LXdlYi1jb21wb25lbnRzLW1vZGVybi9kaXN0JylcclxuICB2YXIgZmlsZXMgPSBmc3gucmVhZGRpclN5bmMocGFja2FnZUxpYlBhdGgpXHJcbiAgZmlsZXMuZm9yRWFjaCgoZmlsZU5hbWUpID0+IHtcclxuICAgIGlmIChmaWxlTmFtZSAmJiBmaWxlTmFtZS5zdWJzdHIoMCwgNCkgPT0gJ2V4dC0nKSB7XHJcbiAgICAgIHZhciBlbmQgPSBmaWxlTmFtZS5zdWJzdHIoNCkuaW5kZXhPZignLmNvbXBvbmVudCcpXHJcbiAgICAgIGlmIChlbmQgPj0gMCkge1xyXG4gICAgICAgIEV4dFdlYkNvbXBvbmVudHMucHVzaChmaWxlTmFtZS5zdWJzdHJpbmcoMCwgZW5kICsgNCkpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KVxyXG4gIGxvZ3Yob3B0aW9ucy52ZXJib3NlLCBgSWRlbnRpZnlpbmcgYWxsIGV4dC0ke29wdGlvbnMuZnJhbWV3b3JrfS1tb2Rlcm4gbW9kdWxlc2ApXHJcbiAgLy9sb2codmFycy5hcHAsIGBJZGVudGlmeWluZyBhbGwgZXh0LSR7b3B0aW9ucy5mcmFtZXdvcmt9IG1vZHVsZXNgKVxyXG4gIHJldHVybiBFeHRXZWJDb21wb25lbnRzXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfd3JpdGVGaWxlc1RvUHJvZEZvbGRlcih2YXJzLCBvcHRpb25zKSB7XHJcbiAgY29uc3QgbG9ndiA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3ZcclxuICBsb2d2KG9wdGlvbnMudmVyYm9zZSwnRlVOQ1RJT04gX3dyaXRlRmlsZXNUb1Byb2RGb2xkZXIgKGVtcHR5KScpXHJcbiAgdHJ5IHtcclxuICB9XHJcbiAgY2F0Y2ggKGUpIHtcclxuICAgIGNvbnNvbGUubG9nKGUpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbmQoc3RhcnQsIHNldE9mU3ltYm9sc1RvQ2hlY2spIHtcclxuICB2YXIgZW5kaW5nc0FyciA9IFtdO1xyXG5cclxuICBmb3IgKHZhciBpPTA7aTxzZXRPZlN5bWJvbHNUb0NoZWNrLmxlbmd0aDtpKyspIHtcclxuICAgICB2YXIgc3ltYm9sSW5kZXggPSBzdGFydC5pbmRleE9mKHNldE9mU3ltYm9sc1RvQ2hlY2tbaV0pO1xyXG5cclxuICAgICBpZiAoc3ltYm9sSW5kZXggIT09IC0xKSB7XHJcbiAgICAgICBlbmRpbmdzQXJyLnB1c2goc3ltYm9sSW5kZXgpO1xyXG4gICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIE1hdGgubWluKC4uLmVuZGluZ3NBcnIpXHJcbn1cclxuIl19