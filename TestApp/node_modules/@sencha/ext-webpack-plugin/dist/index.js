'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require('@babel/polyfill');

const fs = require('fs');

const path = require('path');

const pluginUtil = require(`./pluginUtil`);

const replace = require("replace");

const configBundleName = "[name].js";
const defaultBundleName = "main.js";
const tmpCmdPluginFile = "temp.txt";

class ExtWebpackPlugin {
  constructor(options) {
    var constructorOutput = pluginUtil._constructor(options);

    this.vars = constructorOutput.vars;
    this.options = constructorOutput.options;
    this.vars.child = null;
    var me = this;
    var v = [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`];
    v.forEach(eventType => {
      process.on(eventType, function (eventType) {
        if (v.includes(eventType)) {
          if (me.vars.child != null) {
            console.log('\nnode process and sencha cmd process ended');
            me.vars.child.kill();
            me.vars.child = null;
          } else {
            if (eventType != 0) {
              console.log('\nnode process ended');
            }
          }

          process.exit();
        }
      });
    }); //console.log('added')
  }

  apply(compiler) {
    const vars = this.vars;
    const options = this.options;
    const app = this.app;

    if (!compiler.hooks) {
      console.log('not webpack 4');
      return;
    }

    compiler.hooks.thisCompilation.tap(`ext-this-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK thisCompilation`);

      pluginUtil._thisCompilation(compiler, compilation, vars, options);

      if (vars.pluginErrors.length > 0) {
        compilation.errors.push(new Error(vars.pluginErrors.join("")));
        return;
      }
    }); //var cRun = 0;

    compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK compilation`); //if (cRun == 0) {

      pluginUtil._compilation(compiler, compilation, vars, options); //}
      //cRun++;

    });
    compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
      pluginUtil.logh(app, `HOOK afterCompile`);

      pluginUtil._afterCompile(compiler, compilation, vars, options);
    });
    compiler.hooks.afterEmit.tapAsync('ext-after-emit', (compilation, callback) => {
      pluginUtil._emit(compiler, compilation, vars, options, callback);
    });
    compiler.hooks.done.tap(`ext-done`, stats => {
      pluginUtil.logh(app, `HOOK done`); // this.postBuildProcess(stats.compilation.outputOptions)

      pluginUtil._done(stats, vars, options);
    });
  }

}

exports.default = ExtWebpackPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZnMiLCJwYXRoIiwicGx1Z2luVXRpbCIsInJlcGxhY2UiLCJjb25maWdCdW5kbGVOYW1lIiwiZGVmYXVsdEJ1bmRsZU5hbWUiLCJ0bXBDbWRQbHVnaW5GaWxlIiwiRXh0V2VicGFja1BsdWdpbiIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImNvbnN0cnVjdG9yT3V0cHV0IiwiX2NvbnN0cnVjdG9yIiwidmFycyIsImNoaWxkIiwibWUiLCJ2IiwiZm9yRWFjaCIsImV2ZW50VHlwZSIsInByb2Nlc3MiLCJvbiIsImNvbnNvbGUiLCJsb2ciLCJraWxsIiwiZXhpdCIsImFwcGx5IiwiY29tcGlsZXIiLCJhcHAiLCJob29rcyIsInRoaXNDb21waWxhdGlvbiIsInRhcCIsImNvbXBpbGF0aW9uIiwibG9naCIsIl90aGlzQ29tcGlsYXRpb24iLCJwbHVnaW5FcnJvcnMiLCJsZW5ndGgiLCJlcnJvcnMiLCJwdXNoIiwiRXJyb3IiLCJqb2luIiwiX2NvbXBpbGF0aW9uIiwiYWZ0ZXJDb21waWxlIiwiX2FmdGVyQ29tcGlsZSIsImFmdGVyRW1pdCIsInRhcEFzeW5jIiwiY2FsbGJhY2siLCJfZW1pdCIsImRvbmUiLCJzdGF0cyIsIl9kb25lIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUNBQSxPQUFPLENBQUMsaUJBQUQsQ0FBUDs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1FLElBQUksR0FBR0YsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUcsVUFBVSxHQUFHSCxPQUFPLENBQUUsY0FBRixDQUExQjs7QUFDQSxNQUFNSSxPQUFPLEdBQUdKLE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUVBLE1BQU1LLGdCQUFnQixHQUFHLFdBQXpCO0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsU0FBMUI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxVQUF6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QlgsR0FBNUIsQ0FBZ0MsbUJBQWhDLEVBQXNEQyxXQUFELElBQWlCO0FBQ3BFNUIsTUFBQUEsVUFBVSxDQUFDNkIsSUFBWCxDQUFnQkwsR0FBaEIsRUFBc0IsbUJBQXRCOztBQUNBeEIsTUFBQUEsVUFBVSxDQUFDdUMsYUFBWCxDQUF5QmhCLFFBQXpCLEVBQW1DSyxXQUFuQyxFQUFnRGxCLElBQWhELEVBQXNESCxPQUF0RDtBQUNELEtBSEQ7QUFLQWdCLElBQUFBLFFBQVEsQ0FBQ0UsS0FBVCxDQUFlZSxTQUFmLENBQXlCQyxRQUF6QixDQUFrQyxnQkFBbEMsRUFBb0QsQ0FBQ2IsV0FBRCxFQUFjYyxRQUFkLEtBQTJCO0FBQzdFMUMsTUFBQUEsVUFBVSxDQUFDMkMsS0FBWCxDQUFpQnBCLFFBQWpCLEVBQTJCSyxXQUEzQixFQUF3Q2xCLElBQXhDLEVBQThDSCxPQUE5QyxFQUF1RG1DLFFBQXZEO0FBQ0QsS0FGRDtBQUlBbkIsSUFBQUEsUUFBUSxDQUFDRSxLQUFULENBQWVtQixJQUFmLENBQW9CakIsR0FBcEIsQ0FBeUIsVUFBekIsRUFBcUNrQixLQUFELElBQVc7QUFDN0M3QyxNQUFBQSxVQUFVLENBQUM2QixJQUFYLENBQWdCTCxHQUFoQixFQUFzQixXQUF0QixFQUQ2QyxDQUU3Qzs7QUFDQXhCLE1BQUFBLFVBQVUsQ0FBQzhDLEtBQVgsQ0FBaUJELEtBQWpCLEVBQXdCbkMsSUFBeEIsRUFBOEJILE9BQTlCO0FBQ0QsS0FKRDtBQUtEOztBQXhFbUMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcclxucmVxdWlyZSgnQGJhYmVsL3BvbHlmaWxsJylcclxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBwbHVnaW5VdGlsID0gcmVxdWlyZShgLi9wbHVnaW5VdGlsYClcclxuY29uc3QgcmVwbGFjZSA9IHJlcXVpcmUoXCJyZXBsYWNlXCIpO1xyXG5cclxuY29uc3QgY29uZmlnQnVuZGxlTmFtZSA9IFwiW25hbWVdLmpzXCI7XHJcbmNvbnN0IGRlZmF1bHRCdW5kbGVOYW1lID0gXCJtYWluLmpzXCJcclxuY29uc3QgdG1wQ21kUGx1Z2luRmlsZSA9IFwidGVtcC50eHRcIlxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXh0V2VicGFja1BsdWdpbiB7XHJcblxyXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcclxuICAgIHZhciBjb25zdHJ1Y3Rvck91dHB1dCA9IHBsdWdpblV0aWwuX2NvbnN0cnVjdG9yKG9wdGlvbnMpXHJcbiAgICB0aGlzLnZhcnMgPSBjb25zdHJ1Y3Rvck91dHB1dC52YXJzXHJcbiAgICB0aGlzLm9wdGlvbnMgPSBjb25zdHJ1Y3Rvck91dHB1dC5vcHRpb25zXHJcblxyXG4gICAgdGhpcy52YXJzLmNoaWxkID0gbnVsbDtcclxuICAgIHZhciBtZSA9IHRoaXM7XHJcblxyXG4gICAgdmFyIHYgPSBbYGV4aXRgLCBgU0lHSU5UYCwgYFNJR1VTUjFgLCBgU0lHVVNSMmAsIGB1bmNhdWdodEV4Y2VwdGlvbmAsIGBTSUdURVJNYF1cclxuICAgIHYuZm9yRWFjaChldmVudFR5cGUgPT4ge1xyXG4gICAgICBwcm9jZXNzLm9uKGV2ZW50VHlwZSwgZnVuY3Rpb24oZXZlbnRUeXBlKXtcclxuICAgICAgICBpZiAobWUudmFycy5jaGlsZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnXFxubm9kZSBwcm9jZXNzIGFuZCBzZW5jaGEgY21kIHByb2Nlc3MgZW5kZWQnKVxyXG4gICAgICAgICAgbWUudmFycy5jaGlsZC5raWxsKCk7XHJcbiAgICAgICAgICBtZS52YXJzLmNoaWxkID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICBpZiAoZXZlbnRUeXBlICE9IDApIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1xcbm5vZGUgcHJvY2VzcyBlbmRlZCcpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHByb2Nlc3MuZXhpdCgpO1xyXG4gICAgICB9KTtcclxuICAgIH0pXHJcbiAgICAvL2NvbnNvbGUubG9nKCdhZGRlZCcpXHJcbiAgfVxyXG5cclxuICBhcHBseShjb21waWxlcikge1xyXG4gICAgY29uc3QgdmFycyA9IHRoaXMudmFyc1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMub3B0aW9uc1xyXG4gICAgY29uc3QgYXBwID0gdGhpcy5hcHBcclxuXHJcbiAgICBpZiAoIWNvbXBpbGVyLmhvb2tzKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdub3Qgd2VicGFjayA0Jyk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb21waWxlci5ob29rcy50aGlzQ29tcGlsYXRpb24udGFwKGBleHQtdGhpcy1jb21waWxhdGlvbmAsIChjb21waWxhdGlvbikgPT4ge1xyXG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyB0aGlzQ29tcGlsYXRpb25gKVxyXG4gICAgICBwbHVnaW5VdGlsLl90aGlzQ29tcGlsYXRpb24oY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zKVxyXG5cclxuICAgICAgaWYgKHZhcnMucGx1Z2luRXJyb3JzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb21waWxhdGlvbi5lcnJvcnMucHVzaCggbmV3IEVycm9yKHZhcnMucGx1Z2luRXJyb3JzLmpvaW4oXCJcIikpIClcclxuICAgICAgICByZXR1cm5cclxuICAgICAgfVxyXG4gICAgfSlcclxuXHJcbiAgICAvL3ZhciBjUnVuID0gMDtcclxuICAgIGNvbXBpbGVyLmhvb2tzLmNvbXBpbGF0aW9uLnRhcChgZXh0LWNvbXBpbGF0aW9uYCwgKGNvbXBpbGF0aW9uKSA9PiB7XHJcbiAgICAgIHBsdWdpblV0aWwubG9naChhcHAsIGBIT09LIGNvbXBpbGF0aW9uYClcclxuICAgICAgLy9pZiAoY1J1biA9PSAwKSB7XHJcbiAgICAgICAgcGx1Z2luVXRpbC5fY29tcGlsYXRpb24oY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zKTtcclxuICAgICAgLy99XHJcbiAgICAgIC8vY1J1bisrO1xyXG4gICAgfSlcclxuXHJcbiAgICBjb21waWxlci5ob29rcy5hZnRlckNvbXBpbGUudGFwKCdleHQtYWZ0ZXItY29tcGlsZScsIChjb21waWxhdGlvbikgPT4ge1xyXG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBhZnRlckNvbXBpbGVgKVxyXG4gICAgICBwbHVnaW5VdGlsLl9hZnRlckNvbXBpbGUoY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zKVxyXG4gICAgfSlcclxuXHJcbiAgICBjb21waWxlci5ob29rcy5hZnRlckVtaXQudGFwQXN5bmMoJ2V4dC1hZnRlci1lbWl0JywgKGNvbXBpbGF0aW9uLCBjYWxsYmFjaykgPT4ge1xyXG4gICAgICBwbHVnaW5VdGlsLl9lbWl0KGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucywgY2FsbGJhY2spXHJcbiAgICB9KVxyXG5cclxuICAgIGNvbXBpbGVyLmhvb2tzLmRvbmUudGFwKGBleHQtZG9uZWAsIChzdGF0cykgPT4ge1xyXG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBkb25lYClcclxuICAgICAgLy8gdGhpcy5wb3N0QnVpbGRQcm9jZXNzKHN0YXRzLmNvbXBpbGF0aW9uLm91dHB1dE9wdGlvbnMpXHJcbiAgICAgIHBsdWdpblV0aWwuX2RvbmUoc3RhdHMsIHZhcnMsIG9wdGlvbnMpXHJcbiAgICB9KVxyXG4gIH1cclxufVxyXG4iXX0=